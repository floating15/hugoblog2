<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>kaggle-ASHRAE | haoming&#39;s blog</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/other/">other</a></li>
      
      <li><a href="/post/">Posts</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">kaggle-ASHRAE</span></h1>

<h2 class="date">2021/07/23</h2>
</div>

<main>
<h1 id="预测建筑物的能源消耗">预测建筑物的能源消耗</h1>
<p><a href="href.pdf">pdf</a></p>
<p>ASHRAE（American Society of Heating, Refrigerating and Air-Conditioning Engineers），中文名称“美国采暖、制冷与空调工程师学会”，于1894年在美国纽约成立，是由暖通空调（HVAC）工程师所组成的学会，全球拥有超过54,000名成员。协会及其成员专注于建筑系统、能源效率、室内空气质量、制冷和行业内的可持续性。通过调研、标准编写、出版和继续教育，ASHRAE发展至现在的规模。</p>
<p>问：夏天给大楼降温需要多少钱？</p>
<p>答：非常多！政府正在进行投资，以降低能源成本，减少排放。但是问题是，这些改进是否真的有效？</p>
<p>在这次竞赛中，我们通过<strong>预测冷水表、电表、热水表和蒸汽表的读数</strong>来对这些节能投资进行更好的估计。数据来自近三年来1000栋建筑中的各表读数。大型投资者和金融机构将更倾向于在这一领域投资，以提高建筑能源使用效率。</p>
<p>我们将这个notebook分为不同的步骤，你可以使用下面的链接来浏览此notebook。</p>
<ul>
<li><a href="#step1">Step 1</a>: 导入数据</li>
<li><a href="#step2">Step 2</a>: 探索性数据分析</li>
<li><a href="#step3">Step 3</a>: 数据预处理</li>
<li><a href="#step4">Step 4</a>: LightGBM</li>
<li><a href="#step5">Step 5</a>: 结果预测</li>
</ul>
<p>在该项目中包含了如下的问题：</p>
<ul>
<li><a href="#question1">问题 1</a>: 回顾课上内容并查阅资料，归纳总结数据预处理需要的步骤。</li>
<li><a href="#question2">问题 2</a>: 思考此处为何要进行对数转换。</li>
<li><a href="#question3">问题 3</a>: 查阅资料，总结LightGBM与CatBoost的差异。</li>
</ul>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#408080;font-style:italic">#导入必要的库</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">pandas</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">pd</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">numpy</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">np</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">os</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">gc</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">copy</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">warnings</span>

<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">lightgbm</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">lgb</span>
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">lightgbm</span> <span style="color:#008000;font-weight:bold">import</span> LGBMRegressor
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">sklearn.metrics</span> <span style="color:#008000;font-weight:bold">import</span> mean_squared_log_error
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">sklearn.model_selection</span> <span style="color:#008000;font-weight:bold">import</span> StratifiedKFold, KFold
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">tqdm.notebook</span> <span style="color:#008000;font-weight:bold">import</span> tqdm
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">matplotlib.pyplot</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">plt</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">seaborn</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">sns</span>

warnings<span style="color:#666">.</span>filterwarnings(<span style="color:#ba2121">&#39;ignore&#39;</span>)
pd<span style="color:#666">.</span>set_option(<span style="color:#ba2121">&#34;max_columns&#34;</span>, <span style="color:#666">500</span>)
<span style="color:#666">%</span>matplotlib inline
</code></pre></div><p><a id='step1'></a></p>
<h1 id="1-导入数据">1. 导入数据</h1>
<p>ASHRAE给出的数据包含大量的特征数据，包括仪表读数，天气和建筑的数据等等。该问题为典型的监督学习问题。比赛举办方提供了6个csv文件，包括5个数据集与1个提交样本。其中数据集的字段含义为：</p>
<p><code>[train/test].csv</code></p>
<ul>
<li>building_id：建筑原数据的外键</li>
<li>meter : 仪表的id码, {0: 电表 , 1: 冷水表, 2: 蒸汽表, 3: 热水表}，不是每栋建筑都有全部类型的仪表</li>
<li>timestamp：读表的时间</li>
<li>meter_reading：目标变量, 用千瓦时（或等效值）表示的能耗。这是带有测量误差的真实数据，其中site0的电表读数出现问题，单位是千英热</li>
</ul>
<p><code>building_meta.csv</code></p>
<ul>
<li>site_id: 天气文件的外键</li>
<li>building_id: training.csv对应的外键</li>
<li>primary_use: 基于EnergyStar property type definitions的建筑物活动的主要类别的指标（education, office…)</li>
<li>square_feet: 建筑物的总建筑面积</li>
<li>year_built: 建筑完成的年份</li>
<li>floor_count: 建筑物层数</li>
</ul>
<p><code>weather_[train/test].csv</code>：气象站提供的气象数据,尽可能接近现场。</p>
<ul>
<li>site_id: 天气文件的外键</li>
<li>air_temperature: 气温，单位为摄氏度</li>
<li>cloud_coverage: 天空中被云层覆盖的部分，单位为oktas</li>
<li>dew_temperature: 露点温度，单位为摄氏度</li>
<li>precip_depth_1_hr: 降水深度，单位为毫米</li>
<li>sea_level_pressure: 海平面压力，单位为毫巴/公顷</li>
<li>wind_direction: 风向，使用的是指南针方向（0-360）</li>
<li>wind_speed: 风速，单位为米每秒</li>
</ul>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">train <span style="color:#666">=</span> pd<span style="color:#666">.</span>read_csv(<span style="color:#ba2121">&#34;../input/ashrae-energy-prediction/train.csv&#34;</span>, parse_dates<span style="color:#666">=</span>[<span style="color:#ba2121">&#34;timestamp&#34;</span>])
test <span style="color:#666">=</span> pd<span style="color:#666">.</span>read_csv(<span style="color:#ba2121">&#34;../input/ashrae-energy-prediction/test.csv&#34;</span>, parse_dates<span style="color:#666">=</span>[<span style="color:#ba2121">&#34;timestamp&#34;</span>])
building <span style="color:#666">=</span> pd<span style="color:#666">.</span>read_csv(<span style="color:#ba2121">&#39;../input/ashrae-energy-prediction/building_metadata.csv&#39;</span>)
weather_train <span style="color:#666">=</span> pd<span style="color:#666">.</span>read_csv(<span style="color:#ba2121">&#39;../input/ashrae-energy-prediction/weather_train.csv&#39;</span>, parse_dates<span style="color:#666">=</span>[<span style="color:#ba2121">&#34;timestamp&#34;</span>])
weather_test <span style="color:#666">=</span> pd<span style="color:#666">.</span>read_csv(<span style="color:#ba2121">&#34;../input/ashrae-energy-prediction/weather_test.csv&#34;</span>, parse_dates<span style="color:#666">=</span>[<span style="color:#ba2121">&#34;timestamp&#34;</span>])
</code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df <span style="color:#666">=</span> pd<span style="color:#666">.</span>DataFrame(
    weather_train[<span style="color:#ba2121">&#39;site_id&#39;</span>]<span style="color:#666">.</span>value_counts()
)
df
</code></pre></div><p><a id='step2'></a></p>
<h1 id="2-探索性数据分析">2. 探索性数据分析</h1>
<ul>
<li>根据主办方提供的数据，&ldquo;meter&quot;代表仪表的类型，对应关系为 {0: 电表 , 1: 冷水表, 2: 蒸汽表, 3: 热水表}</li>
<li>观察各个建筑的仪表读数，可以发现，其中一些建筑的读数在某些区间出现了持续为0的异常情况,也有读数异常的高的值</li>
<li>可以通过修改<code>site</code>,<code>meter_type</code>,<code>primary_use</code>三个参数选择想要绘制的数据</li>
</ul>
<p>关联train表格和building表格用于作图</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">train_plot <span style="color:#666">=</span> train<span style="color:#666">.</span>merge(building, on<span style="color:#666">=</span><span style="color:#ba2121">&#39;building_id&#39;</span>, how<span style="color:#666">=</span><span style="color:#ba2121">&#39;left&#39;</span>)

site <span style="color:#666">=</span> <span style="color:#666">0</span> <span style="color:#408080;font-style:italic">#建筑物的地点</span>
meter_type <span style="color:#666">=</span> <span style="color:#666">1</span> <span style="color:#408080;font-style:italic">#仪表的类型</span>
primary_use <span style="color:#666">=</span> <span style="color:#ba2121">&#39;Education&#39;</span> <span style="color:#408080;font-style:italic">#建筑物的用途</span>

r <span style="color:#666">=</span> <span style="color:#008000">int</span>(
    np<span style="color:#666">.</span>ceil(
        <span style="color:#008000">len</span>(
            train_plot[
                (train_plot[<span style="color:#ba2121">&#39;site_id&#39;</span>] <span style="color:#666">==</span> site) <span style="color:#666">&amp;</span>
                (train_plot[<span style="color:#ba2121">&#39;primary_use&#39;</span>] <span style="color:#666">==</span> primary_use) <span style="color:#666">&amp;</span>
                (train_plot[<span style="color:#ba2121">&#39;meter&#39;</span>] <span style="color:#666">==</span> meter_type)
            ][<span style="color:#ba2121">&#39;building_id&#39;</span>]<span style="color:#666">.</span>value_counts(dropna<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">False</span>)<span style="color:#666">.</span>index<span style="color:#666">.</span>to_list()
        ) <span style="color:#666">/</span> <span style="color:#666">2</span>
    )
)
</code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">s <span style="color:#666">=</span> <span style="color:#008000">enumerate</span>(
    train_plot[
        (train_plot[<span style="color:#ba2121">&#39;site_id&#39;</span>] <span style="color:#666">==</span> site) <span style="color:#666">&amp;</span>
        (train_plot[<span style="color:#ba2121">&#39;primary_use&#39;</span>] <span style="color:#666">==</span> primary_use) <span style="color:#666">&amp;</span>
        (train_plot[<span style="color:#ba2121">&#39;meter&#39;</span>] <span style="color:#666">==</span> meter_type)
    ][<span style="color:#ba2121">&#39;building_id&#39;</span>]<span style="color:#666">.</span>value_counts(dropna<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">False</span>)<span style="color:#666">.</span>index<span style="color:#666">.</span>to_list()
)
</code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, axes <span style="color:#666">=</span> plt<span style="color:#666">.</span>subplots(r,<span style="color:#666">2</span>,figsize<span style="color:#666">=</span>(<span style="color:#666">14</span>, <span style="color:#666">36</span>), dpi<span style="color:#666">=</span><span style="color:#666">100</span>)
<span style="color:#008000;font-weight:bold">for</span> i, building_id <span style="color:#a2f;font-weight:bold">in</span> s:
    train_plot[
        (train_plot[<span style="color:#ba2121">&#39;site_id&#39;</span>] <span style="color:#666">==</span> site) <span style="color:#666">&amp;</span>
        (train_plot[<span style="color:#ba2121">&#39;primary_use&#39;</span>] <span style="color:#666">==</span> primary_use) <span style="color:#666">&amp;</span>
        (train_plot[<span style="color:#ba2121">&#39;meter&#39;</span>] <span style="color:#666">==</span> meter_type) <span style="color:#666">&amp;</span>
        (train_plot[<span style="color:#ba2121">&#39;building_id&#39;</span>] <span style="color:#666">==</span> building_id)
    ][
        [<span style="color:#ba2121">&#39;timestamp&#39;</span>, <span style="color:#ba2121">&#39;meter_reading&#39;</span>]
    ]<span style="color:#666">.</span>set_index(<span style="color:#ba2121">&#39;timestamp&#39;</span>)<span style="color:#666">.</span>resample(<span style="color:#ba2121">&#39;H&#39;</span>)<span style="color:#666">.</span>mean()[<span style="color:#ba2121">&#39;meter_reading&#39;</span>]<span style="color:#666">.</span>plot(
        ax<span style="color:#666">=</span>axes[i<span style="color:#666">%</span>r][i<span style="color:#666">//</span>r],
        alpha<span style="color:#666">=</span><span style="color:#666">0.8</span>,
        label<span style="color:#666">=</span><span style="color:#ba2121">&#39;By hour&#39;</span>,
        color<span style="color:#666">=</span><span style="color:#ba2121">&#39;tab:blue&#39;</span>
    )<span style="color:#666">.</span>set_ylabel(<span style="color:#ba2121">&#39;Mean meter reading&#39;</span>, fontsize<span style="color:#666">=</span><span style="color:#666">13</span>);

    train_plot[
        (train_plot[<span style="color:#ba2121">&#39;site_id&#39;</span>] <span style="color:#666">==</span> site) <span style="color:#666">&amp;</span>
        (train_plot[<span style="color:#ba2121">&#39;primary_use&#39;</span>] <span style="color:#666">==</span> primary_use) <span style="color:#666">&amp;</span>
        (train_plot[<span style="color:#ba2121">&#39;meter&#39;</span>] <span style="color:#666">==</span> meter_type) <span style="color:#666">&amp;</span>
        (train_plot[<span style="color:#ba2121">&#39;building_id&#39;</span>] <span style="color:#666">==</span> building_id )
    ][
        [<span style="color:#ba2121">&#39;timestamp&#39;</span>, <span style="color:#ba2121">&#39;meter_reading&#39;</span>]
    ]<span style="color:#666">.</span>set_index(<span style="color:#ba2121">&#39;timestamp&#39;</span>)<span style="color:#666">.</span>resample(<span style="color:#ba2121">&#39;D&#39;</span>)<span style="color:#666">.</span>mean()[<span style="color:#ba2121">&#39;meter_reading&#39;</span>]<span style="color:#666">.</span>plot(
        ax<span style="color:#666">=</span>axes[i<span style="color:#666">%</span>r][i<span style="color:#666">//</span>r],
        alpha<span style="color:#666">=</span><span style="color:#666">1</span>,
        label<span style="color:#666">=</span><span style="color:#ba2121">&#39;By day&#39;</span>,
        color<span style="color:#666">=</span><span style="color:#ba2121">&#39;tab:orange&#39;</span>
    )<span style="color:#666">.</span>set_xlabel(<span style="color:#ba2121">&#39;&#39;</span>);

axes[i<span style="color:#666">%</span>r][i<span style="color:#666">//</span>r]<span style="color:#666">.</span>legend();
axes[i<span style="color:#666">%</span>r][i<span style="color:#666">//</span>r]<span style="color:#666">.</span>set_title(<span style="color:#ba2121">&#39;building_id: &#39;</span> <span style="color:#666">+</span> <span style="color:#008000">str</span>(building_id ), fontsize<span style="color:#666">=</span><span style="color:#666">13</span>);
plt<span style="color:#666">.</span>subplots_adjust(hspace<span style="color:#666">=</span><span style="color:#666">0.45</span>)

<span style="color:#008000;font-weight:bold">del</span> train_plot,fig,axes,r
gc<span style="color:#666">.</span>collect();
</code></pre></div><p><a id='step3'></a></p>
<h1 id="3-数据预处理">3. 数据预处理</h1>
<p><a id='question1'></a></p>
<h3 id="__问题-1__"><strong>问题 1:</strong></h3>
<p>回顾课上内容并查阅资料，归纳总结数据预处理需要的步骤。</p>
<p><strong>回答:</strong></p>
<h2 id="31-数据类型转换">3.1 数据类型转换</h2>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">compress_dataframe</span>(df):
    <span style="color:#ba2121">&#39;&#39;&#39;将所有数据的类型都转换为数值型&#39;&#39;&#39;</span>
    result <span style="color:#666">=</span> df<span style="color:#666">.</span>copy()
    <span style="color:#008000;font-weight:bold">for</span> col <span style="color:#a2f;font-weight:bold">in</span> result<span style="color:#666">.</span>columns:
        col_data <span style="color:#666">=</span> result[col]
        dn <span style="color:#666">=</span> col_data<span style="color:#666">.</span>dtype<span style="color:#666">.</span>name
        <span style="color:#008000;font-weight:bold">if</span> dn <span style="color:#666">==</span> <span style="color:#ba2121">&#34;object&#34;</span>:
            result[col] <span style="color:#666">=</span> pd<span style="color:#666">.</span>to_numeric(col_data<span style="color:#666">.</span>astype(<span style="color:#ba2121">&#34;category&#34;</span>)<span style="color:#666">.</span>cat<span style="color:#666">.</span>codes, downcast<span style="color:#666">=</span><span style="color:#ba2121">&#34;integer&#34;</span>)
        <span style="color:#008000;font-weight:bold">elif</span> dn <span style="color:#666">==</span> <span style="color:#ba2121">&#34;bool&#34;</span>:
            result[col] <span style="color:#666">=</span> col_data<span style="color:#666">.</span>astype(<span style="color:#ba2121">&#34;int8&#34;</span>)
        <span style="color:#008000;font-weight:bold">elif</span> dn<span style="color:#666">.</span>startswith(<span style="color:#ba2121">&#34;int&#34;</span>) <span style="color:#a2f;font-weight:bold">or</span> (col_data<span style="color:#666">.</span>round() <span style="color:#666">==</span> col_data)<span style="color:#666">.</span>all():
            result[col] <span style="color:#666">=</span> pd<span style="color:#666">.</span>to_numeric(col_data, downcast<span style="color:#666">=</span><span style="color:#ba2121">&#34;integer&#34;</span>)
        <span style="color:#008000;font-weight:bold">else</span>:
            result[col] <span style="color:#666">=</span> pd<span style="color:#666">.</span>to_numeric(col_data, downcast<span style="color:#666">=</span><span style="color:#ba2121">&#39;float&#39;</span>)
    <span style="color:#008000;font-weight:bold">return</span> result
</code></pre></div><h2 id="32-缺失值填充与特征扩展">3.2 缺失值填充与特征扩展</h2>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">set_time</span>(df):
    df<span style="color:#666">.</span>timestamp <span style="color:#666">=</span> (df<span style="color:#666">.</span>timestamp <span style="color:#666">-</span> pd<span style="color:#666">.</span>to_datetime(<span style="color:#ba2121">&#34;2016-01-01&#34;</span>))<span style="color:#666">.</span>dt<span style="color:#666">.</span>total_seconds() <span style="color:#666">//</span> <span style="color:#666">3600</span>
    <span style="color:#408080;font-style:italic">#这里将timestamp转换成了16年1月1日0点开始计算的小时数‘//’代表除法运算后取整</span>
    <span style="color:#008000;font-weight:bold">return</span> df

<span style="color:#408080;font-style:italic"># 根据分析得出各个site来自哪个时区，来修正时间</span>
<span style="color:#408080;font-style:italic"># https://www.kaggle.com/patrick0302/locate-cities-according-weather-temperature</span>
site_GMT_offsets <span style="color:#666">=</span> [<span style="color:#666">-</span><span style="color:#666">5</span>, <span style="color:#666">0</span>, <span style="color:#666">-</span><span style="color:#666">7</span>, <span style="color:#666">-</span><span style="color:#666">5</span>, <span style="color:#666">-</span><span style="color:#666">8</span>, <span style="color:#666">0</span>, <span style="color:#666">-</span><span style="color:#666">5</span>, <span style="color:#666">-</span><span style="color:#666">5</span>, <span style="color:#666">-</span><span style="color:#666">5</span>, <span style="color:#666">-</span><span style="color:#666">6</span>, <span style="color:#666">-</span><span style="color:#666">7</span>, <span style="color:#666">-</span><span style="color:#666">5</span>, <span style="color:#666">0</span>, <span style="color:#666">-</span><span style="color:#666">6</span>, <span style="color:#666">-</span><span style="color:#666">5</span>, <span style="color:#666">-</span><span style="color:#666">5</span>]

<span style="color:#408080;font-style:italic">#转换天气数据表格中的时间,并填充缺失值</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">weather_set_time</span>(df,time_zone):
    df<span style="color:#666">.</span>timestamp <span style="color:#666">=</span> (df<span style="color:#666">.</span>timestamp <span style="color:#666">-</span> pd<span style="color:#666">.</span>to_datetime(<span style="color:#ba2121">&#34;2016-01-01&#34;</span>))<span style="color:#666">.</span>dt<span style="color:#666">.</span>total_seconds() <span style="color:#666">//</span> <span style="color:#666">3600</span>
    
    GMT_offset_map <span style="color:#666">=</span> {site: offset <span style="color:#008000;font-weight:bold">for</span> site, offset <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">enumerate</span>(site_GMT_offsets)}
    df<span style="color:#666">.</span>timestamp <span style="color:#666">=</span> df<span style="color:#666">.</span>timestamp <span style="color:#666">+</span> df<span style="color:#666">.</span>site_id<span style="color:#666">.</span>map(GMT_offset_map)
    <span style="color:#408080;font-style:italic">#根据时区的不同，统一时间</span>
    site_dfs <span style="color:#666">=</span> []
    <span style="color:#008000;font-weight:bold">for</span> site_id <span style="color:#a2f;font-weight:bold">in</span> df<span style="color:#666">.</span>site_id<span style="color:#666">.</span>unique():
        <span style="color:#408080;font-style:italic"># 确保包括所有可能的小时数</span>
        site_df <span style="color:#666">=</span> df[df<span style="color:#666">.</span>site_id <span style="color:#666">==</span> site_id]<span style="color:#666">.</span>set_index(<span style="color:#ba2121">&#34;timestamp&#34;</span>)<span style="color:#666">.</span>reindex(time_zone)
        site_df<span style="color:#666">.</span>site_id <span style="color:#666">=</span> site_id
        <span style="color:#008000;font-weight:bold">for</span> col <span style="color:#a2f;font-weight:bold">in</span> [c <span style="color:#008000;font-weight:bold">for</span> c <span style="color:#a2f;font-weight:bold">in</span> site_df<span style="color:#666">.</span>columns <span style="color:#008000;font-weight:bold">if</span> c <span style="color:#666">!=</span> <span style="color:#ba2121">&#34;site_id&#34;</span>]:
            site_df[<span style="color:#ba2121">f</span><span style="color:#ba2121">&#34;had_</span><span style="color:#b68;font-weight:bold">{</span>col<span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#34;</span>] <span style="color:#666">=</span> <span style="color:#666">~</span>site_df[col]<span style="color:#666">.</span>isna()
            site_df[col] <span style="color:#666">=</span> site_df[col]<span style="color:#666">.</span>interpolate(limit_direction<span style="color:#666">=</span><span style="color:#ba2121">&#39;both&#39;</span>, method<span style="color:#666">=</span><span style="color:#ba2121">&#39;linear&#39;</span>)
            <span style="color:#408080;font-style:italic"># 这里使用中位数来填充缺失值</span>
            site_df[col] <span style="color:#666">=</span> site_df[col]<span style="color:#666">.</span>fillna(df[col]<span style="color:#666">.</span>median())
        site_dfs<span style="color:#666">.</span>append(site_df)
    df <span style="color:#666">=</span> pd<span style="color:#666">.</span>concat(site_dfs)<span style="color:#666">.</span>reset_index()  <span style="color:#408080;font-style:italic"># make timestamp back into a regular column</span>
    <span style="color:#008000;font-weight:bold">for</span> col <span style="color:#a2f;font-weight:bold">in</span> df<span style="color:#666">.</span>columns:
        <span style="color:#008000;font-weight:bold">if</span> df[col]<span style="color:#666">.</span>isna()<span style="color:#666">.</span>any(): df[<span style="color:#ba2121">f</span><span style="color:#ba2121">&#34;had_</span><span style="color:#b68;font-weight:bold">{</span>col<span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#34;</span>] <span style="color:#666">=</span> <span style="color:#666">~</span>df[col]<span style="color:#666">.</span>isna()
    <span style="color:#408080;font-style:italic">#如果某列其中有缺失值，就增加一列新的特征：had_xxx 表示这一行在xxx这一列是否有记录</span>
    <span style="color:#008000;font-weight:bold">return</span> df
    
<span style="color:#408080;font-style:italic">#增加星期，月份，时间的特征</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">_add_time_features</span>(X):
    <span style="color:#008000;font-weight:bold">return</span> X<span style="color:#666">.</span>assign(tm_day_of_week<span style="color:#666">=</span>((X<span style="color:#666">.</span>timestamp <span style="color:#666">//</span> <span style="color:#666">24</span>) <span style="color:#666">%</span> <span style="color:#666">7</span>), tm_hour_of_day<span style="color:#666">=</span>(X<span style="color:#666">.</span>timestamp <span style="color:#666">%</span> <span style="color:#666">24</span>))

building <span style="color:#666">=</span> compress_dataframe(building<span style="color:#666">.</span>fillna(<span style="color:#666">-</span><span style="color:#666">1</span>))<span style="color:#666">.</span>set_index(<span style="color:#ba2121">&#34;building_id&#34;</span>)

train <span style="color:#666">=</span> compress_dataframe(set_time(train))
test <span style="color:#666">=</span> compress_dataframe(set_time(test))<span style="color:#666">.</span>set_index(<span style="color:#ba2121">&#34;row_id&#34;</span>)
weather_train <span style="color:#666">=</span> compress_dataframe(weather_set_time(weather_train,<span style="color:#008000">range</span>(<span style="color:#666">8784</span>)))<span style="color:#666">.</span>set_index([<span style="color:#ba2121">&#34;site_id&#34;</span>, <span style="color:#ba2121">&#34;timestamp&#34;</span>])
weather_test <span style="color:#666">=</span> compress_dataframe(weather_set_time(weather_test,<span style="color:#008000">range</span>(<span style="color:#666">8784</span>,<span style="color:#666">26304</span>)))<span style="color:#666">.</span>set_index([<span style="color:#ba2121">&#34;site_id&#34;</span>, <span style="color:#ba2121">&#34;timestamp&#34;</span>])
</code></pre></div><h2 id="33-关联数据">3.3 关联数据</h2>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">combined_data</span>(df,weather):
    df <span style="color:#666">=</span> compress_dataframe(df<span style="color:#666">.</span>join(building, on<span style="color:#666">=</span><span style="color:#ba2121">&#34;building_id&#34;</span>)<span style="color:#666">.</span>join(weather,
        on<span style="color:#666">=</span>[<span style="color:#ba2121">&#34;site_id&#34;</span>, <span style="color:#ba2121">&#34;timestamp&#34;</span>])<span style="color:#666">.</span>fillna(<span style="color:#666">-</span><span style="color:#666">1</span>))
    <span style="color:#008000;font-weight:bold">return</span> df<span style="color:#666">.</span>drop(columns<span style="color:#666">=</span>[<span style="color:#ba2121">&#34;meter_reading&#34;</span>]),df<span style="color:#666">.</span>meter_reading
</code></pre></div><h2 id="34-异常值处理">3.4 异常值处理</h2>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">make_is_bad_zero</span>(Xy_subset, min_interval<span style="color:#666">=</span><span style="color:#666">48</span>, summer_start<span style="color:#666">=</span><span style="color:#666">3000</span>, summer_end<span style="color:#666">=</span><span style="color:#666">7500</span>):
    <span style="color:#408080;font-style:italic">#夏天，3000/24=125，7500/24=312.5,第125天到第312.5天为夏天。</span>

    meter <span style="color:#666">=</span> Xy_subset<span style="color:#666">.</span>meter_id<span style="color:#666">.</span>iloc[<span style="color:#666">0</span>]
    is_zero <span style="color:#666">=</span> Xy_subset<span style="color:#666">.</span>meter_reading <span style="color:#666">==</span> <span style="color:#666">0</span> <span style="color:#408080;font-style:italic">#返回读数为0的电表的indices</span>
    <span style="color:#008000;font-weight:bold">if</span> meter <span style="color:#666">==</span> <span style="color:#666">0</span>:
        <span style="color:#408080;font-style:italic">#电表的度数不应该为0，所以电表（meter为0）读数为0的行从training dataframe中drop掉</span>
        <span style="color:#008000;font-weight:bold">return</span> is_zero

    transitions <span style="color:#666">=</span> (is_zero <span style="color:#666">!=</span> is_zero<span style="color:#666">.</span>shift(<span style="color:#666">1</span>))<span style="color:#408080;font-style:italic">#出现0和非0变化的位置</span>
    all_sequence_ids <span style="color:#666">=</span> transitions<span style="color:#666">.</span>cumsum()<span style="color:#408080;font-style:italic">#到各位置出现的变化的和，是一个pd.Seires</span>
    ids <span style="color:#666">=</span> all_sequence_ids[is_zero]<span style="color:#666">.</span>rename(<span style="color:#ba2121">&#34;ids&#34;</span>)<span style="color:#408080;font-style:italic">#将其中读数为0的提取出来</span>
    <span style="color:#008000;font-weight:bold">if</span> meter <span style="color:#a2f;font-weight:bold">in</span> [<span style="color:#666">2</span>, <span style="color:#666">3</span>]:
        <span style="color:#408080;font-style:italic"># 蒸汽和热水有可能在夏天被关闭</span>
        keep <span style="color:#666">=</span> <span style="color:#008000">set</span>(ids[(Xy_subset<span style="color:#666">.</span>timestamp <span style="color:#666">&lt;</span> summer_start) <span style="color:#666">|</span>
                       (Xy_subset<span style="color:#666">.</span>timestamp <span style="color:#666">&gt;</span> summer_end)]<span style="color:#666">.</span>unique())<span style="color:#408080;font-style:italic">#不在夏天的indices</span>
        is_bad <span style="color:#666">=</span> ids<span style="color:#666">.</span>isin(keep) <span style="color:#666">&amp;</span> (ids<span style="color:#666">.</span>map(ids<span style="color:#666">.</span>value_counts()) <span style="color:#666">&gt;=</span> min_interval) 
        <span style="color:#408080;font-style:italic">#将不在夏天却被关闭的蒸汽和热水表提取出来，至少被关闭了48小时以上的</span>
    <span style="color:#008000;font-weight:bold">elif</span> meter <span style="color:#666">==</span> <span style="color:#666">1</span>:
        time_ids <span style="color:#666">=</span> ids<span style="color:#666">.</span>to_frame()<span style="color:#666">.</span>join(Xy_subset<span style="color:#666">.</span>timestamp)<span style="color:#666">.</span>set_index(<span style="color:#ba2121">&#34;timestamp&#34;</span>)<span style="color:#666">.</span>ids<span style="color:#408080;font-style:italic">#将ids和timestamp对应起来</span>
        is_bad <span style="color:#666">=</span> ids<span style="color:#666">.</span>map(ids<span style="color:#666">.</span>value_counts()) <span style="color:#666">&gt;=</span> min_interval<span style="color:#408080;font-style:italic">#关闭时间大于48小时的</span>

        <span style="color:#408080;font-style:italic"># 冷水在冬天可能被关闭</span>
        jan_id <span style="color:#666">=</span> time_ids<span style="color:#666">.</span>get(<span style="color:#666">0</span>, <span style="color:#008000;font-weight:bold">False</span>)<span style="color:#408080;font-style:italic">#一月份的开始的id</span>
        dec_id <span style="color:#666">=</span> time_ids<span style="color:#666">.</span>get(<span style="color:#666">8283</span>, <span style="color:#008000;font-weight:bold">False</span>)<span style="color:#408080;font-style:italic">#十二月份开始的id</span>
        <span style="color:#008000;font-weight:bold">if</span> (jan_id <span style="color:#a2f;font-weight:bold">and</span> dec_id <span style="color:#a2f;font-weight:bold">and</span> jan_id <span style="color:#666">==</span> time_ids<span style="color:#666">.</span>get(<span style="color:#666">500</span>, <span style="color:#008000;font-weight:bold">False</span>) <span style="color:#a2f;font-weight:bold">and</span>
                dec_id <span style="color:#666">==</span> time_ids<span style="color:#666">.</span>get(<span style="color:#666">8783</span>, <span style="color:#008000;font-weight:bold">False</span>)):
        <span style="color:#408080;font-style:italic">#如果一月500小时和十二月500小时的读表都为0的话</span>
            is_bad <span style="color:#666">=</span> is_bad <span style="color:#666">&amp;</span> (<span style="color:#666">~</span>(ids<span style="color:#666">.</span>isin(<span style="color:#008000">set</span>([jan_id, dec_id]))))
            <span style="color:#408080;font-style:italic">#将这一部分的的行从is_bad中删除</span>
    <span style="color:#008000;font-weight:bold">else</span>:
        <span style="color:#008000;font-weight:bold">raise</span> <span style="color:#d2413a;font-weight:bold">Exception</span>(<span style="color:#ba2121">f</span><span style="color:#ba2121">&#34;Unexpected meter type: </span><span style="color:#b68;font-weight:bold">{</span>meter<span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#34;</span>)

    result <span style="color:#666">=</span> is_zero<span style="color:#666">.</span>copy()
    result<span style="color:#666">.</span>update(is_bad)
    <span style="color:#008000;font-weight:bold">return</span> result

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">find_bad_zeros</span>(X, y):
    <span style="color:#ba2121">&#34;&#34;&#34;返回仅包含应该删除的行的Index&#34;&#34;&#34;</span>
    Xy <span style="color:#666">=</span> X<span style="color:#666">.</span>assign(meter_reading<span style="color:#666">=</span>y, meter_id<span style="color:#666">=</span>X<span style="color:#666">.</span>meter)
    is_bad_zero <span style="color:#666">=</span> Xy<span style="color:#666">.</span>groupby([<span style="color:#ba2121">&#34;building_id&#34;</span>, <span style="color:#ba2121">&#34;meter&#34;</span>])<span style="color:#666">.</span>apply(make_is_bad_zero)
    <span style="color:#008000;font-weight:bold">return</span> is_bad_zero[is_bad_zero]<span style="color:#666">.</span>index<span style="color:#666">.</span>droplevel([<span style="color:#666">0</span>, <span style="color:#666">1</span>])

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">find_bad_sitezero</span>(X):
    <span style="color:#ba2121">&#34;&#34;&#34;返回Site 0 读数异常的行的index.&#34;&#34;&#34;</span>
    <span style="color:#008000;font-weight:bold">return</span> X[(X<span style="color:#666">.</span>timestamp <span style="color:#666">&lt;</span> <span style="color:#666">3378</span>) <span style="color:#666">&amp;</span> (X<span style="color:#666">.</span>site_id <span style="color:#666">==</span> <span style="color:#666">0</span>) <span style="color:#666">&amp;</span> (X<span style="color:#666">.</span>meter <span style="color:#666">==</span> <span style="color:#666">0</span>)]<span style="color:#666">.</span>index

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">find_bad_building1099</span>(X, y):
    <span style="color:#ba2121">&#34;&#34;&#34;返回建筑1099的读数异常高的行的index .&#34;&#34;&#34;</span>
    <span style="color:#008000;font-weight:bold">return</span> X[(X<span style="color:#666">.</span>building_id <span style="color:#666">==</span> <span style="color:#666">1099</span>) <span style="color:#666">&amp;</span> (X<span style="color:#666">.</span>meter <span style="color:#666">==</span> <span style="color:#666">2</span>) <span style="color:#666">&amp;</span> (y <span style="color:#666">&gt;</span> <span style="color:#666">3e4</span>)]<span style="color:#666">.</span>index

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">find_bad_rows</span>(X, y):
    <span style="color:#008000;font-weight:bold">return</span> find_bad_zeros(X, y)<span style="color:#666">.</span>union(find_bad_sitezero(X))<span style="color:#666">.</span>union(find_bad_building1099(X, y))
</code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">X, y <span style="color:#666">=</span> combined_data(train,weather_train)

bad_rows <span style="color:#666">=</span> find_bad_rows(X, y)
<span style="color:#408080;font-style:italic">#输出异常值的index</span>
pd<span style="color:#666">.</span>Series(bad_rows<span style="color:#666">.</span>sort_values())<span style="color:#666">.</span>to_csv(<span style="color:#ba2121">&#34;rows_to_drop.csv&#34;</span>, header<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">False</span>, index<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">False</span>)

X <span style="color:#666">=</span> X<span style="color:#666">.</span>drop(index<span style="color:#666">=</span>bad_rows)
y <span style="color:#666">=</span> y<span style="color:#666">.</span>reindex_like(X)

X <span style="color:#666">=</span> _add_time_features(X)
X <span style="color:#666">=</span> compress_dataframe(X)
X <span style="color:#666">=</span> X<span style="color:#666">.</span>drop(columns<span style="color:#666">=</span><span style="color:#ba2121">&#34;timestamp&#34;</span>)  <span style="color:#408080;font-style:italic"># drop掉原本的timestamp</span>

<span style="color:#008000;font-weight:bold">del</span> bad_rows,train,weather_train
gc<span style="color:#666">.</span>collect();
</code></pre></div><h2 id="35-评价函数">3.5 评价函数</h2>
<p>由于需要预测连续值，因此需要采用回归模型。由于该项目是Kaggle赛题，测试集是使用均方根对数误差 RMSLE（Root Mean Squared Logarithmic Error, RMSLE)评测的，因此这里只能使用RMSLE。RMSLE的计算公式为：</p>
<p>$${\rm RMSLE} = \sqrt{\frac{1}{n} \sum_{i=1}^n (\log(p_i + 1) - \log(a_i+1))^2 }$$</p>
<p>其中</p>
<ul>
<li>$n$（public/private）数据集中的样本总数,</li>
<li>$p_i$ 是目标的预测值</li>
<li>$a_i$ 第i个目标的真实值.</li>
<li>$\log(x)$ 是自然对数</li>
</ul>
<p>我们只需要对目标值进行$y = \log(y+1)$的变换，就可以使用常见的RMSE作为评价函数，我们使用numpy中的log1p就可以实现。</p>
<p>注意：进行预测的时候需要使用$y = e^y-1$将目标值转换回去，可以使用 y = np.exp1m(y)。</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#408080;font-style:italic">#对目标值进行变换</span>
y <span style="color:#666">=</span> np<span style="color:#666">.</span>log1p(y)
</code></pre></div><p><a id='question2'></a></p>
<h3 id="__问题-2__"><strong>问题 2:</strong></h3>
<p>思考此处为何要进行对数转换。</p>
<p><strong>回答:</strong></p>
<p><a id='step4'></a></p>
<h1 id="4-lightgbm">4. LightGBM</h1>
<h2 id="41-模型参数">4.1 模型参数</h2>
<p>LightGBM 主要调节的参数包括：</p>
<ul>
<li><code>learning_rate</code>：迭代步长,学习率；</li>
<li><code>num_leaves</code>：LightGBM使用leaf-wise的算法，在调节树的复杂度时，使用num_leaves，较小导致欠拟合，较大导致过拟合；</li>
<li><code>subsample</code>：0-1之间，控制每棵树随机采样的比例，减小这个参数的值，算法会更加保守，避免过拟合。但如果这个值设置得过小，可能会导致欠拟合；</li>
<li><code>lambda_l2</code>：L2正则化系数，用来控制过拟合；</li>
<li><code>num_trees</code>：迭代步数。</li>
</ul>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">params <span style="color:#666">=</span> {
    <span style="color:#ba2121">&#39;task&#39;</span>: <span style="color:#ba2121">&#39;train&#39;</span>,
    <span style="color:#ba2121">&#39;boosting_type&#39;</span>: <span style="color:#ba2121">&#39;gbdt&#39;</span>,  
    <span style="color:#ba2121">&#39;objective&#39;</span>: <span style="color:#ba2121">&#39;regression&#39;</span>,  
    <span style="color:#ba2121">&#39;metric&#39;</span>: <span style="color:#ba2121">&#39;rmse&#39;</span>,  
    <span style="color:#ba2121">&#39;num_leaves&#39;</span>: <span style="color:#666">40</span>,  
    <span style="color:#ba2121">&#39;subsample&#39;</span>:<span style="color:#666">0.8</span>,
    <span style="color:#ba2121">&#39;learning_rate&#39;</span>: <span style="color:#666">0.03</span>,  
    <span style="color:#ba2121">&#39;verbose&#39;</span>: <span style="color:#666">1</span>,
    <span style="color:#ba2121">&#39;lambda_l2&#39;</span>:<span style="color:#666">3</span>
}

num_trees <span style="color:#666">=</span> <span style="color:#666">1000</span>

<span style="color:#408080;font-style:italic">#设置分类变量</span>
categorical_features<span style="color:#666">=</span>[<span style="color:#ba2121">&#39;building_id&#39;</span>, <span style="color:#ba2121">&#39;site_id&#39;</span>, <span style="color:#ba2121">&#39;primary_use&#39;</span>, <span style="color:#ba2121">&#39;had_air_temperature&#39;</span>, <span style="color:#ba2121">&#39;had_cloud_coverage&#39;</span>, 
                      <span style="color:#ba2121">&#39;had_dew_temperature&#39;</span>, <span style="color:#ba2121">&#39;had_precip_depth_1_hr&#39;</span>,<span style="color:#ba2121">&#39;had_sea_level_pressure&#39;</span>, <span style="color:#ba2121">&#39;had_wind_direction&#39;</span>,
                      <span style="color:#ba2121">&#39;had_wind_speed&#39;</span>, <span style="color:#ba2121">&#39;tm_day_of_week&#39;</span>, <span style="color:#ba2121">&#39;tm_hour_of_day&#39;</span>]
</code></pre></div><h2 id="42-模型训练">4.2 模型训练</h2>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">n_splits <span style="color:#666">=</span> <span style="color:#666">3</span>

<span style="color:#008000;font-weight:bold">for</span> val <span style="color:#a2f;font-weight:bold">in</span> X[<span style="color:#ba2121">&#39;meter&#39;</span>]<span style="color:#666">.</span>unique():
    X1 <span style="color:#666">=</span> X[X[<span style="color:#ba2121">&#39;meter&#39;</span>] <span style="color:#666">==</span> val]<span style="color:#666">.</span>drop(columns<span style="color:#666">=</span>[<span style="color:#ba2121">&#39;meter&#39;</span>])
    kf <span style="color:#666">=</span> StratifiedKFold(n_splits<span style="color:#666">=</span>n_splits,random_state<span style="color:#666">=</span><span style="color:#666">42</span>)
    <span style="color:#408080;font-style:italic">#使用StratifiedKFold，让指定列在每一个fold中的分布相同，这里设置分为3个fold</span>
    t <span style="color:#666">=</span> <span style="color:#666">0</span>
    <span style="color:#008000;font-weight:bold">for</span> train_index, test_index <span style="color:#a2f;font-weight:bold">in</span> kf<span style="color:#666">.</span>split(X1, X1[<span style="color:#ba2121">&#39;tm_hour_of_day&#39;</span>]):
        <span style="color:#408080;font-style:italic">#让每个fold中[&#39;tm_hour_of_day&#39;]的分布相同</span>
        train_features <span style="color:#666">=</span> X1<span style="color:#666">.</span>iloc[train_index]
        train_target <span style="color:#666">=</span> y[X1<span style="color:#666">.</span>iloc[train_index]<span style="color:#666">.</span>index]
        
        test_features <span style="color:#666">=</span> X1<span style="color:#666">.</span>iloc[test_index]
        test_target <span style="color:#666">=</span> y[X1<span style="color:#666">.</span>iloc[test_index]<span style="color:#666">.</span>index]
        
        d_train <span style="color:#666">=</span> lgb<span style="color:#666">.</span>Dataset(train_features, train_target, categorical_feature<span style="color:#666">=</span>categorical_features)
        d_eval <span style="color:#666">=</span> lgb<span style="color:#666">.</span>Dataset(test_features,test_target, categorical_feature<span style="color:#666">=</span>categorical_features)
        <span style="color:#008000">print</span>(<span style="color:#ba2121">&#34;Building model meter :&#34;</span>,val,<span style="color:#ba2121">&#39;fold:&#39;</span>,t)        
        
        md <span style="color:#666">=</span> lgb<span style="color:#666">.</span>train(params, d_train, num_boost_round<span style="color:#666">=</span>num_trees, valid_sets<span style="color:#666">=</span>(d_train, d_eval), 
                       early_stopping_rounds<span style="color:#666">=</span><span style="color:#666">200</span>,verbose_eval<span style="color:#666">=</span><span style="color:#666">20</span>)
        md<span style="color:#666">.</span>save_model(<span style="color:#ba2121">&#39;lgb_val</span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#ba2121">_fold</span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#ba2121">.bin&#39;</span><span style="color:#666">.</span>format(val,t))
        t <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#008000;font-weight:bold">del</span> X1  
        
<span style="color:#008000;font-weight:bold">del</span> d_train, d_eval, train_features, test_features, md
gc<span style="color:#666">.</span>collect();
</code></pre></div><p><a id='question3'></a></p>
<h3 id="__问题-3__"><strong>问题 3:</strong></h3>
<p>查阅资料，总结LightGBM与CatBoost的差异。</p>
<p><strong>回答:</strong></p>
<p><a id='step5'></a></p>
<h1 id="5-结果预测">5. 结果预测</h1>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">X <span style="color:#666">=</span> compress_dataframe(test<span style="color:#666">.</span>join(building, on<span style="color:#666">=</span><span style="color:#ba2121">&#34;building_id&#34;</span>)<span style="color:#666">.</span>join(weather_test, on<span style="color:#666">=</span>[<span style="color:#ba2121">&#34;site_id&#34;</span>, <span style="color:#ba2121">&#34;timestamp&#34;</span>])<span style="color:#666">.</span>fillna(<span style="color:#666">-</span><span style="color:#666">1</span>))
X <span style="color:#666">=</span> compress_dataframe(_add_time_features(X))
X <span style="color:#666">=</span> X<span style="color:#666">.</span>drop(columns<span style="color:#666">=</span><span style="color:#ba2121">&#34;timestamp&#34;</span>)  <span style="color:#408080;font-style:italic"># drop掉原本的timestamp</span>

<span style="color:#008000;font-weight:bold">del</span> test, weather_test
gc<span style="color:#666">.</span>collect();
</code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#408080;font-style:italic">#输出预测结果</span>
result <span style="color:#666">=</span> np<span style="color:#666">.</span>zeros(<span style="color:#008000">len</span>(X))
<span style="color:#008000;font-weight:bold">for</span> val <span style="color:#a2f;font-weight:bold">in</span> X[<span style="color:#ba2121">&#39;meter&#39;</span>]<span style="color:#666">.</span>unique():
    ix <span style="color:#666">=</span> np<span style="color:#666">.</span>nonzero((X[<span style="color:#ba2121">&#39;meter&#39;</span>] <span style="color:#666">==</span> val)<span style="color:#666">.</span>to_numpy())
    <span style="color:#008000;font-weight:bold">for</span> i <span style="color:#a2f;font-weight:bold">in</span> tqdm(<span style="color:#008000">range</span>(n_splits)):
        <span style="color:#408080;font-style:italic">#加载刚才保存的模型</span>
        model <span style="color:#666">=</span> lgb<span style="color:#666">.</span>Booster(model_file<span style="color:#666">=</span><span style="color:#ba2121">&#39;lgb_val</span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#ba2121">_fold</span><span style="color:#b68;font-weight:bold">{}</span><span style="color:#ba2121">.bin&#39;</span><span style="color:#666">.</span>format(val, i))
        result[ix] <span style="color:#666">+=</span> model<span style="color:#666">.</span>predict(X<span style="color:#666">.</span>iloc[ix]<span style="color:#666">.</span>drop(columns<span style="color:#666">=</span>[<span style="color:#ba2121">&#39;meter&#39;</span>]), num_iteration<span style="color:#666">=</span>model<span style="color:#666">.</span>best_iteration)<span style="color:#666">/</span>n_splits
        <span style="color:#008000;font-weight:bold">del</span> model
        gc<span style="color:#666">.</span>collect();
    
predictions <span style="color:#666">=</span> pd<span style="color:#666">.</span>DataFrame({
    <span style="color:#ba2121">&#34;row_id&#34;</span>: X<span style="color:#666">.</span>index,
    <span style="color:#ba2121">&#34;meter_reading&#34;</span>: np<span style="color:#666">.</span>clip(np<span style="color:#666">.</span>expm1(result), <span style="color:#666">0</span>, <span style="color:#008000;font-weight:bold">None</span>)
})

<span style="color:#408080;font-style:italic"># float_format设置保留四位小数，减少文件大小，为文件上传节省时间</span>
predictions<span style="color:#666">.</span>to_csv(<span style="color:#ba2121">&#34;submission.csv&#34;</span>, index<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">False</span>, float_format<span style="color:#666">=</span><span style="color:#ba2121">&#34;</span><span style="color:#b68;font-weight:bold">%.4f</span><span style="color:#ba2121">&#34;</span>)
</code></pre></div><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
</code></pre></div>
</main>

  <footer>
  <script defer src="//yihui.org/js/math-code.js"></script>
<script defer src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script defer src="//yihui.org/js/center-img.js"></script>

  
  <hr/>
  © <a href="https://yihui.org">Yihui Xie</a> 2017 &ndash; 2022 | <a href="https://github.com/yihui">Github</a> | <a href="https://twitter.com/xieyihui">Twitter</a>
  
  </footer>
  </body>
</html>

